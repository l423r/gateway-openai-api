# Вариант 2: TLS termination на Gateway (MITM-прокси для HTTPS)

Подробное описание варианта, при котором HTTPS-трафик к выбранным доменам идёт через ваш Spring Cloud Gateway: gateway принимает TLS, расшифровывает запрос, проксирует его (для доменов из списка — через upstream), отдаёт ответ, зашифрованный своим сертификатом. Остальные домены gateway может пересылать напрямую без upstream.

---

## 1. Общая схема

```
Устройство (браузер)  →  Роутер (DNAT 443)  →  Gateway :443 (TLS)
                                                      ↓
                                    Расшифровка TLS, смотрю Host
                                    ├─ Host в proxy.domains → запрос через upstream → целевой сайт
                                    └─ остальные Host → запрос напрямую → целевой сайт
                                                      ↓
                                    Ответ шифрую своим сертификатом → роутер → устройство
```

- Роутер перенаправляет весь HTTPS (порт 443) на gateway.
- Gateway слушает 443, принимает TLS, расшифровывает, читает заголовок **Host**.
- Если Host в списке **proxy.domains** — запрос уходит через **upstream**-прокси (ваш VPN/обход).
- Если Host не в списке — запрос уходит **напрямую** на целевой хост (без upstream).
- Ответ gateway снова шифрует своим сертификатом и отдаёт клиенту. Чтобы браузер не ругался, на устройстве должен быть установлен и доверенный **корневой сертификат (CA)**, которым подписан сертификат gateway.

---

## 2. Что нужно на стороне Gateway (сервера)

### 2.1. Приложение

- **Слушать порт 443** по HTTPS (отдельный connector в Spring Boot или только 443 вместо 8080 для HTTPS).
- **Сертификат сервера:** выпущен вашим собственным CA (или купленный, но тогда все домены должны быть в нём — неудобно для динамического прокси). На практике для MITM нужен свой CA и сертификат, который gateway будет подставлять для **любого** запрошенного хоста (dynamic SNI/cert per request) или один wildcard/мульти-домен — в зависимости от реализации.
- **Логика маршрутизации после расшифровки TLS:**
  - Host ∈ proxy.domains → маршрут через upstream (как сейчас transparent-proxy + UpstreamProxyCustomizer).
  - Остальные Host → маршрут «прямая пересылка» на тот же Host без upstream.

Технически в Spring Cloud Gateway это означает: включить TLS (например, `server.ssl.*` или отдельный Netty server на 443), подставить свой `SslContext` с сертификатом (и при необходимости динамической выдачей сертификата под любой Host через свой CA). Детали реализации (код) выходят за рамки этой инструкции; здесь — что должно быть в итоге.

### 2.2. Создание своего CA и сертификата для gateway

Сертификат на gateway должен быть подписан **вашим корневым CA**. Этот же корневой сертификат вы потом устанавливаете на Android, Windows 11 и телевизор.

Ниже — пример через OpenSSL. Команды даны для **Linux/macOS** (bash) и для **Windows 11**.

**Шаг 1: корневой CA (один раз)**

**Linux / macOS (bash):**

```bash
# Каталог для CA (можно свой путь)
mkdir -p ~/ca && cd ~/ca

# Закрытый ключ CA
openssl genrsa -out ca.key 4096
chmod 600 ca.key

# Корневой сертификат CA (действует 10 лет)
openssl req -x509 -new -nodes -key ca.key -sha256 -days 3650 -out ca.crt \
  -subj "/CN=My Gateway Root CA/O=Home/O=Gateway"
```

**Windows 11:**

1. Установите OpenSSL, если его ещё нет:
   - **Вариант A:** [Скачать OpenSSL для Windows](https://slproweb.com/products/Win32OpenSSL.html) (раздел "Win64 OpenSSL"), установить и добавить папку `bin` в PATH, либо открывать команды из папки установки (например `C:\Program Files\OpenSSL-Win64\bin`).
   - **Вариант B:** Установить через winget: `winget install ShiningLight.OpenSSL` (если доступен), затем в PATH появится `openssl`.
   - **Вариант C:** В составе [Git for Windows](https://git-scm.com/download/win) уже есть OpenSSL — откройте **Git Bash** и выполняйте команды ниже в нём (как в Linux); тогда каталог можно задать так: `mkdir -p ~/ca && cd ~/ca`.

2. Откройте **PowerShell** или **cmd** (если используете установленный OpenSSL без Git Bash). Создайте каталог и перейдите в него:

```powershell
# Каталог для CA (можно свой путь, например C:\ca)
mkdir $env:USERPROFILE\ca -Force
cd $env:USERPROFILE\ca
```

3. Создайте закрытый ключ CA:

```powershell
openssl genrsa -out ca.key 4096
```

4. Создайте корневой сертификат CA (действует 10 лет):

```powershell
openssl req -x509 -new -nodes -key ca.key -sha256 -days 3650 -out ca.crt -subj "/CN=My Gateway Root CA/O=Home/O=Gateway"
```

Если PowerShell ругается на кавычки, используйте один аргумент в двойных кавычках:

```powershell
openssl req -x509 -new -nodes -key ca.key -sha256 -days 3650 -out ca.crt -subj "//CN=My Gateway Root CA/O=Home/O=Gateway"
```

(Слэш в начале `//CN=...` в некоторых сборках OpenSSL под Windows экранирует первый слэш в subject.)

В результате в папке `%USERPROFILE%\ca` (например `C:\Users\ВашеИмя\ca`) появятся файлы **ca.key** и **ca.crt**. На Windows отдельно ограничивать права на ca.key не обязательно, но храните папку в безопасном месте и не копируйте **ca.key** на устройства.

Файл **ca.crt** — это и есть тот «корневой сертификат», который нужно установить на все устройства. Файл **ca.key** храните только на безопасном носителе и не копируйте на устройства.

**Шаг 2: сертификат для gateway (подписан CA)**

Gateway должен принимать подключения по разным именам (youtube.com, instagram.com и т.д.). Варианты:

- **Вариант A:** один сертификат с несколькими SAN (Subject Alternative Name) — перечислите все домены, которые будут запрашиваться (или используйте wildcard, если ваш CA так настроен).
- **Вариант B:** динамическая выдача сертификата под любой Host в момент подключения (требует кода на gateway, который по SNI запрашивает/генерирует серт и подписывает его вашим CA).

Для простоты ниже — один сертификат с SAN для нескольких доменов (пример).

```bash
# Закрытый ключ gateway
openssl genrsa -out gateway.key 2048
chmod 600 gateway.key

# Файл с расширениями (SAN) — подставьте свои домены
cat > gateway.ext << EOF
authorityKeyIdentifier=keyid,issuer
basicConstraints=CA:FALSE
keyUsage=digitalSignature,nonRepudiation,keyEncipherment
subjectAltName=@alt_names
[alt_names]
DNS.1=*.youtube.com
DNS.2=youtube.com
DNS.3=*.instagram.com
DNS.4=api.openai.com
EOF

# Запрос на подпись (CSR)
openssl req -new -key gateway.key -out gateway.csr \
  -subj "/CN=gateway.local/O=Gateway"

# Подпись сертификата CA (действует 825 дней, как принято для серверов)
openssl x509 -req -in gateway.csr -CA ca.crt -CAkey ca.key -CAcreateserial \
  -out gateway.crt -days 825 -sha256 -extfile gateway.ext
```

**Windows 11 (PowerShell или cmd):** выполнять из того же каталога, где лежат **ca.crt** и **ca.key** (например `%USERPROFILE%\ca`).

1. Закрытый ключ gateway и CSR:

```powershell
openssl genrsa -out gateway.key 2048
openssl req -new -key gateway.key -out gateway.csr -subj "/CN=gateway.local/O=Gateway"
```

2. Файл расширений **gateway.ext** создайте вручную в том же каталоге (Блокнот или `notepad gateway.ext`). Содержимое (домены подставьте свои):

```ini
authorityKeyIdentifier=keyid,issuer
basicConstraints=CA:FALSE
keyUsage=digitalSignature,nonRepudiation,keyEncipherment
subjectAltName=@alt_names
[alt_names]
DNS.1=*.youtube.com
DNS.2=youtube.com
DNS.3=*.instagram.com
DNS.4=api.openai.com
```

Сохраните файл в кодировке UTF-8 или ANSI, без лишнего расширения вроде .txt.

3. Подпись сертификата CA:

```powershell
openssl x509 -req -in gateway.csr -CA ca.crt -CAkey ca.key -CAcreateserial -out gateway.crt -days 825 -sha256 -extfile gateway.ext
```

В итоге для TLS на gateway нужны **gateway.crt** и **gateway.key**. Для установки на устройства нужен только **ca.crt**.

**Раздача ca.crt на устройства:** скопируйте файл на телефон/ПК/телевизор (почта, облако, USB, общая папка в LAN) и установите по инструкциям ниже.

---

## 3. Настройка роутера

Добавить перенаправление порта **443** на gateway (IP и порт подставьте свои; если gateway слушает HTTPS на 443, то порт 443):

```bash
iptables -t nat -A PREROUTING -p tcp --dport 443 -j DNAT --to-destination 88.210.20.137:443
```

Если HTTPS на gateway слушает на другом порту (например 8443), укажите его:

```bash
iptables -t nat -A PREROUTING -p tcp --dport 443 -j DNAT --to-destination 88.210.20.137:8443
```

Это правило сохраните в скрипте `/jffs/scripts/firewall-start` вместе с правилом для порта 80 (см. [router-setup.md](router-setup.md)), чтобы после перезагрузки роутера настройки не слетали.

---

## 4. Установка корневого сертификата (ca.crt) на устройствах

Устройство должно доверять вашему CA, иначе браузер покажет ошибку «Недоверенный сертификат» или «Ваше подключение не защищено».

### 4.1. Android (телефон или планшет)

1. Скопируйте файл **ca.crt** на устройство (почта, мессенджер, USB, Google Drive и т.п.). Если файл пришёл как вложение, откройте его или сохраните в «Загрузки».
2. Откройте **Настройки** → **Безопасность** (или **Безопасность и конфиденциальность** / **Биометрия и безопасность** — название зависит от версии и оболочки).
3. Найдите раздел **Шифрование и учётные данные** (или **Учётные данные** / **Хранилище учётных данных**).
4. Выберите **Установить сертификат** (или **Установить из хранилища** / **Установить CA-сертификат**).
5. Укажите **CA-сертификат** (не «сертификат клиента»).
6. Выберите файл **ca.crt** (если система попросит имя — можно задать, например «Gateway CA»).
7. Подтвердите PIN/пароль/отпечаток при запросе.
8. Должно появиться сообщение, что сертификат установлен.

**Важно:** На Android 7+ приложения могут не доверять пользовательским CA (только системным). Если после установки в «Пользовательские» браузер или приложение (например, YouTube) всё равно ругаются на сертификат, варианты:

- Установить CA как **системный** — обычно требует root или настройки через **adb** (например, перенос сертификата в системное хранилище). Тогда доверяют все приложения.
- Часть браузеров (Chrome и др.) используют системное хранилище; если CA установлен только как «пользовательский», в некоторых версиях Android они его не подхватывают. Проверьте в настройках браузера «Безопасность» / «Сертификаты».

**Где искать пункты на разных оболочках:**

- **Чистый Android (Pixel и т.п.):** Настройки → Безопасность → Шифрование и учётные данные → Установить сертификат → CA-сертификат.
- **Samsung:** Настройки → Биометрия и безопасность → Другие параметры безопасности → Установить сертификаты → CA-сертификат.
- **Xiaomi / MIUI:** Настройки → Пароли и безопасность → Шифрование и учётные данные → Установить сертификат → CA-сертификат.

После установки перезапустите браузер и снова откройте https-сайт, который идёт через gateway.

---

### 4.2. Windows 11

Цель — добавить **ca.crt** в хранилище **Доверенные корневые центры сертификации**, чтобы все приложения (в том числе браузеры) доверяли сертификатам, выданным вашим CA.

**Способ 1: через оснастку сертификатов (certmgr)**

1. Скопируйте **ca.crt** на компьютер (например, в папку «Загрузки» или на рабочий стол).
2. Нажмите **Win + R**, введите `certmgr.msc`, Enter.
3. В левой панели откройте **Доверенные корневые центры сертификации** → **Сертификаты**.
4. Правый клик по папке **Сертификаты** → **Все задачи** → **Импорт**.
5. Нажмите **Далее**, укажите путь к файлу **ca.crt**, снова **Далее**.
6. Убедитесь, что выбрано хранилище **Доверенные корневые центры сертификации**, нажмите **Далее** → **Готово**.
7. Подтвердите предупреждение безопасности («Установить сертификат в корневые…») кнопкой **Да**.

**Способ 2: через «Параметры»**

1. **Параметры** (Win + I) → **Конфиденциальность и безопасность** → **Безопасность** → **Управление сертификатами** (в разделе «Безопасность»).
2. Откроется оснастка: перейдите в **Доверенные корневые центры сертификации** → **Сертификаты**, затем, как в способе 1: правый клик → **Все задачи** → **Импорт** и укажите **ca.crt**.

После импорта закройте и снова откройте браузер и проверьте доступ к https-сайтам через gateway.

---

### 4.3. Телевизор на Android (Android TV)

На Android TV нет отдельного пункта «Установить CA» в привычном виде; интерфейс зависит от производителя. Ниже — общие варианты.

**Способ 1: через настройки Android TV (если есть пункт про сертификаты)**

1. **Настройки** → **Сеть и Интернет** (или **Сеть**) → **Расширенные** / **Дополнительно**.
2. Поищите пункты вроде **Безопасность**, **Сертификаты**, **Установить сертификат** или **Учётные данные**. Если есть **Установить CA-сертификат** — выберите его и укажите источник файла (если ТВ даёт выбрать файл с USB/сети).
3. Если ТВ не умеет выбирать файл с флешки, используйте способ 2.

**Способ 2: установка через adb (универсально)**

Если на ТВ включена отладка по USB/сети и есть доступ с ПК:

1. Установите на ПК **adb** (Android SDK Platform-Tools или отдельно adb).
2. Подключитесь к ТВ по сети: `adb connect IP_ТЕЛЕВИЗОРА:5555` (порт может быть другой, смотрите в настройках разработчика на ТВ).
3. Преобразуйте **ca.crt** в формат, который Android принимает для системного CA (имя файла должно быть хэшем субъекта + расширение `.0`). Пример для конвертации и установки:

```bash
# На ПК (Linux/macOS) — получить хэш субъекта
openssl x509 -inform PEM -subject_hash_old -in ca.crt | head -1
# Допустим, вывод: a1b2c3d4

# Скопировать сертификат с именем a1b2c3d4.0
cp ca.crt a1b2c3d4.0

# Установить в системное хранилище (нужен root на ТВ)
adb root
adb remount
adb push a1b2c3d4.0 /system/etc/security/cacerts/
adb shell chmod 644 /system/etc/security/cacerts/a1b2c3d4.0
adb reboot
```

Если на ТВ нет root, записать в `/system` не получится; тогда остаётся только вариант с **пользовательским** сертификатом через adb (если ТВ это поддерживает):

```bash
adb install -r ca.crt
# или
adb shell am start -a android.settings.SECURITY_SETTINGS
# и дальше вручную в интерфейсе ТВ, если появится пункт про сертификаты
```

**Способ 3: производитель-специфичный**

- **Sony (Android TV):** Настройки → Сеть → Дополнительно → иногда есть раздел про прокси/безопасность; установка CA часто только через adb.
- **Philips, TCL, другие на Android TV:** Часто нет пункта «Установить сертификат» в меню; надёжный вариант — установка через **adb** в системное хранилище (если есть root) или в пользовательское (если ТВ после обновления это поддерживает).

**Важно:** На многих Android TV приложения (в том числе YouTube) жёстко привязаны к системным CA. Если CA установлен только как пользовательский, приложение может не доверять сертификату. Полная поддержка обычно при установке CA в `/system/etc/security/cacerts/` (требуется root).

---

## 5. Проверка

1. На gateway: HTTPS слушает 443 (или выбранный порт), сертификат и ключ (gateway.crt, gateway.key) подключены, маршруты для proxy.domains и «остальных» Host настроены.
2. На роутере: правило DNAT для 443 на IP:порт gateway сохранено и выполняется после перезагрузки.
3. На устройстве: **ca.crt** установлен как доверенный корневой CA (на Android — по возможности в системное хранилище).
4. Откройте в браузере https://youtube.com (или другой домен из proxy.domains). Запрос должен уйти на роутер → gateway; в логах gateway — входящий TLS, расшифровка, запрос к upstream или напрямую. Ошибок «Недоверенный сертификат» быть не должно.

---

## 6. Безопасность

- **ca.key** храните только на защищённом сервере/ПК, не передавайте и не ставьте на устройства.
- На устройствах устанавливайте только **ca.crt** (корневой сертификат). Его компрометация даёт возможность подмены любых сайтов для этого устройства в вашей сети, поэтому доступ к серверу и к ca.key должен быть ограничен.
- Периодически можно перевыпускать серверный сертификат (gateway.crt) с тем же CA; корневой ca.crt на устройствах менять не обязательно, пока вы не меняли CA.

**Отдельная инструкция:** создание сертификата в **Windows 11 (cmd)**, перенос на **Debian 10** и настройка **Gateway в Docker** (монтирование .p12, переменные окружения): [certificate-windows-debian-docker.md](certificate-windows-debian-docker.md).

Ссылки: [router-setup.md](router-setup.md) (общие варианты и роутер), [transparent-proxy-flow.md](transparent-proxy-flow.md) (схема потока).
