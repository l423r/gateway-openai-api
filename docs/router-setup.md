# Настройка роутера ASUS RT-AX53U для прозрачного прокси

Инструкция для случая, когда вы **уже подключились по SSH** к роутеру. Gateway доступен по адресу **88.210.20.137:8080**.

**Если нужно, чтобы на gateway шёл только трафик к выбранным доменам (YouTube, Instagram и т.д.), а остальной — не трогать:** используйте настройку **DNS на роутере (dnsmasq)** — подробная пошаговая инструкция в [dnsmasq-only-selected-hosts.md](dnsmasq-only-selected-hosts.md). Ниже — вариант с перенаправлением **всего** трафика на порт 80/443 (iptables DNAT).

---

## 1. Проверка доступа

В сессии SSH на роутере выполните:

```bash
iptables -t nat -L -n
```

Если команда выполнилась без ошибок, можно добавлять правила.

---

## 2. Перенаправление HTTP (порт 80) на Gateway

Весь HTTP-трафик из локальной сети, идущий на порт 80, будет перенаправляться на ваш Spring Cloud Gateway. Там уже настроен список доменов (`proxy.domains`) — только запросы к этим доменам будут проксироваться; остальные не попадут в маршрут прозрачного прокси.

Выполните на роутере **по очереди**:

```bash
# DNAT: пакеты на порт 80 перенаправить на 88.210.20.137:8080
iptables -t nat -A PREROUTING -p tcp --dport 80 -j DNAT --to-destination 88.210.20.137:8080

# MASQUERADE: чтобы ответы от gateway возвращались обратно через роутер к устройству в LAN
iptables -t nat -A POSTROUTING -j MASQUERADE
```

**Важно:** если правило `POSTROUTING -j MASQUERADE` у вас уже есть (часто одно на весь трафик), вторую команду можно не выполнять, чтобы не дублировать. Проверьте:

```bash
iptables -t nat -L POSTROUTING -n -v
```

Если там уже есть MASQUERADE для вашего WAN-интерфейса, новое правило не добавляйте.

---

## 3. Проверка правил

```bash
iptables -t nat -L PREROUTING -n -v
```

В списке должно появиться правило с `dpt:80` и `to:88.210.20.137:8080`.

Проверка работы: с устройства в LAN откройте в браузере любой **HTTP**-сайт из списка доменов gateway (например, запрос к YouTube по HTTP). В логах Spring Cloud Gateway должны появиться входящие запросы.

---

## 4. Сохранение правил после перезагрузки

На прошивке ASUS (Stock/Asuswrt) правила iptables сбрасываются при перезагрузке. Чтобы они применялись снова при старте:

### Вариант A: скрипт в /jffs (если есть JFFS)

1. Включите JFFS в веб-интерфейсе: **Администрирование** → **Система** → **Format JFFS partition** (один раз), затем **Enable JFFS custom scripts**.
2. Создайте каталог и скрипт по SSH:

```bash
mkdir -p /jffs/scripts
cat > /jffs/scripts/firewall-start << 'EOF'
#!/bin/sh
iptables -t nat -A PREROUTING -p tcp --dport 80 -j DNAT --to-destination 88.210.20.137:8080
EOF
chmod +x /jffs/scripts/firewall-start
```

Если правило MASQUERADE у вас отдельно не добавлялось и его нет в системе по умолчанию, добавьте его в тот же скрипт второй строкой (как в шаге 2).

После перезагрузки роутера скрипт `firewall-start` выполнится и правила снова применятся.

### Вариант B: без JFFS

Если раздел JFFS недоступен или скрипты не поддерживаются, правила нужно будет вручную вводить заново после каждой перезагрузки роутера (команды из шага 2).

---

## 5. Отмена (удаление правил)

Чтобы убрать перенаправление порта 80 на gateway:

```bash
iptables -t nat -D PREROUTING -p tcp --dport 80 -j DNAT --to-destination 88.210.20.137:8080
```

(Команда `-D` удаляет правило, аналогичное добавленному с `-A`.)

---

## 6. Ограничение только трафиком «в интернет» (по желанию)

Если нужно перенаправлять на gateway только запросы, изначально уходящие в интернет (не в локальную сеть), можно сузить правило. Например, для типичной LAN-подсети 192.168.1.0/24:

```bash
# Удалить ранее добавленное общее правило (если добавляли)
iptables -t nat -D PREROUTING -p tcp --dport 80 -j DNAT --to-destination 88.210.20.137:8080

# Добавить правило только для трафика не в локальные сети
iptables -t nat -A PREROUTING -p tcp --dport 80 -d ! 192.168.0.0/16 -d ! 10.0.0.0/8 -d ! 172.16.0.0/12 -j DNAT --to-destination 88.210.20.137:8080
```

Подставьте свою LAN-подсеть при необходимости. В скрипт `firewall-start` нужно будет добавить то же правило.

---

## Итог

| Шаг | Действие |
|-----|----------|
| 1 | Проверить, что iptables доступен по SSH |
| 2 | Добавить DNAT для порта 80 → 88.210.20.137:8080 и при необходимости MASQUERADE |
| 3 | Проверить правила и работу с браузера в LAN |
| 4 | Сохранить правила в `/jffs/scripts/firewall-start`, чтобы переживали перезагрузку |
| 5 | При необходимости откатить — удалить правило через `iptables -t nat -D ...` |

Gateway слушает на **88.210.20.137:8080** — убедитесь, что на этом сервере порт 8080 открыт (firewall/security group) и доступен с вашей сети.

---

## Варианты организации трафика через gateway/VPN

Текущая схема (DNAT порта 80 на роутере) проксирует только **HTTP**. Ниже — все основные варианты, как можно пустить трафик (в том числе **HTTPS**, например https://youtube.com) через ваш сервер или «VPN».

---

### Вариант 1. Только HTTP через роутер (как сейчас)

**Что есть:** Роутер перенаправляет порт 80 на gateway; gateway проксирует запросы по списку доменов, опционально через upstream-прокси.

**Плюсы:** Уже реализовано, не нужно ничего менять на устройствах.  
**Минусы:** HTTPS (порт 443) не затрагивается. Почти все сайты (YouTube, Instagram и т.д.) работают по HTTPS, поэтому польза только для редких HTTP-сайтов или для API по HTTP.

**Итог:** Для https://youtube.com этот вариант не подходит.

---

### Вариант 2. TLS termination на Gateway (MITM-прокси для HTTPS)

**Суть:** На роутере добавляется перенаправление и порта **443** на gateway. Gateway принимает HTTPS, расшифровывает его (терминирует TLS), смотрит Host/path, проксирует запрос на целевой сайт (через upstream при необходимости) и шифрует ответ своим сертификатом. Браузер/устройство должны доверять вашему корневому сертификату.

**Что нужно:**
- На gateway: слушать порт 443, свой TLS-сертификат (желательно от своего CA), логика «принять HTTPS → расшифровать → проксировать → зашифровать ответ».
- На роутере: DNAT для порта 443 на 88.210.20.137:443 (или на :8080, если gateway слушает HTTPS там).
- На каждом устройстве в LAN: установить и доверять корневому сертификату вашего CA (иначе браузер покажет предупреждение о недоверенном сертификате).

**Плюсы:** Прозрачно для пользователя после установки сертификата; весь HTTP и HTTPS к выбранным доменам идёт через gateway.  
**Минусы:** Нужна доработка Spring Cloud Gateway (TLS, возможно отдельный коннектор), выпуск и раздача сертификатов, настройка доверия на каждом устройстве; с точки зрения безопасности это MITM.

**Итог:** Позволяет открывать https://youtube.com и пускать трафик через gateway, но требует доработки приложения и настройки доверия к сертификату на клиентах.

**Подробная инструкция по варианту 2** (создание CA и сертификата, настройка роутера, установка корневого сертификата на **Android**, **Windows 11** и **телевизор на Android**): [option2-tls-termination.md](option2-tls-termination.md).

---

### Вариант 3. Прокси на каждом устройстве (без изменения роутера)

**Суть:** Роутер не трогаете. На каждом ПК/телефоне вручную задаёте HTTP/HTTPS-прокси: адрес 88.210.20.137, порт (например 8080 или отдельный для HTTPS, если его реализуете). Весь трафик браузера/приложений, поддерживающих системный прокси, идёт через ваш сервер.

**Плюсы:** Роутер не меняется; можно сразу использовать один gateway для всех устройств.  
**Минусы:** Настраивать нужно на каждом устройстве; не все приложения используют системный прокси; на мобильных часто неудобно.

**Итог:** Для HTTPS нужен на gateway либо обычный HTTP-прокси с поддержкой CONNECT (туннель до целевого хоста), либо свой HTTPS-прокси. Текущий gateway пока не реализует CONNECT для произвольного HTTPS.

---

### Вариант 4. VPN-клиент на роутере (OpenWrt, Asuswrt-Merlin и т.п.)

**Суть:** Ставите на роутер прошивку с поддержкой VPN-клиента (OpenWrt, Asuswrt-Merlin, DD-WRT) и поднимаете WireGuard/OpenVPN до вашего сервера или до стороннего VPN-провайдера. Весь трафик устройств в LAN (или выбранных по правилам) уходит через этот туннель.

**Плюсы:** Не нужно ничего настраивать на каждом устройстве; весь трафик (и HTTP, и HTTPS) идёт через выбранный сервер; нет MITM и своих сертификатов.  
**Минусы:** Нужна смена/дополнение прошивки роутера; ваш Spring Cloud Gateway в этой схеме не участвует как прокси для браузера — трафик идёт на уровне IP через VPN. Gateway можно использовать как VPN-сервер (если поднять на нём WireGuard/OpenVPN) или не использовать вовсе.

**Итог:** Это классический «весь трафик через VPN»; https://youtube.com будет идти через тот хост, куда настроен VPN (ваш 88.210.20.137 или другой).

---

### Вариант 5. VPN или прокси только на отдельных устройствах

**Суть:** Не трогаете роутер. На нужных ПК/телефонах ставите VPN-клиент (WireGuard, OpenVPN, коммерческий VPN) или настраиваете прокси (как в варианте 3). Только эти устройства пускают трафик через «VPN»/прокси.

**Плюсы:** Гибко: выбираете, какие устройства идут через обход.  
**Минусы:** Настраивать каждое устройство; Spring Cloud Gateway в роли прокси для HTTPS нужно дорабатывать отдельно (CONNECT или TLS termination).

**Итог:** https://youtube.com пойдёт через VPN/прокси только на тех устройствах, где включен VPN или прописан прокси.

---

### Вариант 6. DNS на роутере + gateway только для части трафика

**Суть:** На роутере поднимаете свой DNS (dnsmasq и т.п.) и для выбранных доменов (youtube.com, instagram.com) отдаёте IP вашего gateway. Тогда запросы к этим доменам пойдут на gateway. Для HTTPS gateway должен уметь принимать TLS на 443 и терминировать его (как в варианте 2), иначе соединение не установится.

**Плюсы:** Можно точечно направлять только нужные домены на gateway.  
**Минусы:** Сложная отладка; для HTTPS всё равно нужна поддержка TLS на gateway; не все приложения ходят по тем именам, что вы подставили в DNS.

**Итог:** Сам по себе не решает HTTPS без доработки gateway (TLS termination).

---

### Сводка

| Вариант | HTTPS (youtube.com и др.) через ваш сервер? | Роутер меняем? | Устройства настраиваем? |
|--------|---------------------------------------------|----------------|--------------------------|
| 1. Только HTTP (как сейчас) | Нет | Да (DNAT 80) | Нет |
| 2. TLS termination на gateway | Да (после доработки + сертификаты на устройствах) | Да (DNAT 443) | Да (доверие CA) |
| 3. Прокси на каждом устройстве | Да, если gateway умеет HTTPS/CONNECT | Нет | Да (прокси в настройках) |
| 4. VPN на роутере (OpenWrt и т.д.) | Да (весь трафик через VPN) | Да (прошивка + VPN) | Нет |
| 5. VPN/прокси на устройствах | Да | Нет | Да (на каждом) |
| 6. DNS + gateway | Только при TLS на gateway (как вариант 2) | Да (DNS) | Опционально |

Для того чтобы **именно https://youtube.com** шёл через ваш gateway (88.210.20.137), реалистичные пути: **вариант 2** (TLS termination на gateway + доверие сертификату) или **вариант 4** (VPN на роутере, тогда трафик идёт через VPN-сервер, а не через текущий HTTP-прокси в Spring).

---

### Если нужно только определённые домены, остальное не трогать

Вам нужно: **трафик к выбранным доменам** (YouTube, Instagram и т.д.) шёл через gateway/upstream-прокси, а **остальные запросы** — как обычно, без обхода и без отправки на ваш сервер.

**Лучший вариант в этом случае — вариант 2 (TLS termination на gateway)** с такой логикой на самом gateway:

- Запросы с `Host` из списка **proxy.domains** — проксировать через upstream (ваш «VPN»/прокси).
- Запросы с любым другим `Host` — просто пересылать **напрямую** на целевой хост (без upstream). То есть gateway лишь «пробрасывает» их, не пуская через ваш прокси.

Роутер при этом редиректит на gateway весь HTTPS (порт 443). Решение «только эти домены через VPN, остальные не трогать» принимает уже gateway по заголовку Host после расшифровки TLS. Остальной трафик формально проходит через gateway, но не идёт через upstream — для пользователя это «остальное не трогаем».

**Что нужно реализовать:** на gateway — приём HTTPS (порт 443), TLS termination, два типа маршрутов: (1) proxy.domains → upstream, (2) остальные Host → прямой запрос к целевому хосту без upstream. Плюс установка вашего корневого сертификата на устройствах.

**Альтернатива без TLS на gateway:** на роутере можно редиректить на gateway **только трафик к конкретным IP-адресам** (IP YouTube, Instagram и т.д.), собрав их в ipset и добавив в iptables правило DNAT только для этого набора. Тогда до gateway доходит только трафик к выбранным доменам, остальное вообще не попадает на ваш сервер. Минус: IP сайтов меняются, список нужно периодически обновлять (скрипт по крону или вручную).

**Почему остальные варианты хуже подходят:**

- **Вариант 4 (VPN на роутере)** — через VPN уходит **весь** трафик, а не только выбранные домены; разделить по доменам на роутере сложно.
- **Вариант 3 (прокси на устройстве)** — браузер обычно отправляет на прокси либо всё, либо ничего; «только эти домены через прокси» делается на стороне gateway (как в варианте 2), но тогда всё равно весь трафик сначала идёт на gateway.
- **Вариант 6 (DNS)** — подмена DNS затрагивает все запросы к этим доменам; «остальное не трогать» опять упирается в то, что на gateway нужна логика «proxy.domains → upstream, остальное → direct», то есть по сути тот же вариант 2.

**Итог:** для сценария «только эти домены через VPN, остальное не трогать» наиболее подходящий путь — **вариант 2** с двумя режимами на gateway: домены из списка через upstream, все остальные Host — прямая пересылка без upstream.
