# Диагностика прозрачного прокси (видео не грузится, в логах шлюза ничего нет)

Если при открытии ссылки на googlevideo.com (или другой домен из списка) в логах Spring Cloud Gateway **ничего не появляется**, запрос **не доходит до приложения**. Нужно проверить цепочку: DNS → роутер (DNAT) → порт шлюза.

---

## 1. Проверка DNS на клиенте

С устройства, с которого открываете YouTube (ПК/телефон), убедитесь, что домены резолвятся в IP шлюза (**88.210.20.137**).

**Windows (cmd или PowerShell):**
```cmd
nslookup rr5---sn-4g5ednkr.googlevideo.com
```
В ответе должен быть адрес **88.210.20.137**. Если видите другие IP (например, 142.250.x.x) — клиент не использует DNS роутера (dnsmasq), трафик уходит напрямую в интернет, шлюз не участвует.

**Проверка основного домена:**
```cmd
nslookup googlevideo.com
nslookup www.youtube.com
```
Ожидается 88.210.20.137 для всех доменов из списка dnsmasq.

**Что делать, если DNS не тот:** на клиенте в настройках сети указать в качестве DNS адрес роутера (например 192.168.1.1) или убедиться, что DHCP от роутера раздаёт именно его DNS.

---

## 2. Проверка, что запрос доходит до хоста шлюза

С того же клиента выполните (подставьте свой IP шлюза, если он не 88.210.20.137):

```cmd
curl -v -k --connect-timeout 5 "https://88.210.20.137:8443/videoplayback" -H "Host: rr5---sn-4g5ednkr.googlevideo.com"
```

- **Подключился, в логах шлюза появилась строка** `[GATEWAY] Incoming request: ... Host: rr5---sn-4g5ednkr.googlevideo.com` — запрос доходит до приложения, дальше смотреть маршрут и прокси.
- **Подключился, в логах шлюза пусто** — трафик доходит до хоста, но не до приложения (порт 8443 занят другим процессом, или слушает другой интерфейс).
- **Таймаут / connection refused** — до хоста шлюза запрос не доходит: роутер не пробрасывает порт или шлюз слушает другой адрес/порт.

Проверка с **явным портом в URL в браузере:**  
`https://rr5---sn-4g5ednkr.googlevideo.com:8443/videoplayback?...`  
Если в браузере вы не указываете порт, используется 443. Тогда роутер должен делать DNAT **88.210.20.137:443** → **IP_шлюза:8443** (или 443 на самом шлюзе).

---

## 3. Роутер: DNAT / проброс порта

Убедитесь, что на роутере настроен проброс:

- Внешний: **88.210.20.137:443** (или :8443, если клиенты ходят на 8443) → внутренний: **IP машины со шлюзом:8443**.

Если шлюз стоит на том же хосте, что имеет 88.210.20.137, то DNAT может быть не нужен, но тогда шлюз должен слушать на 88.210.20.137:8443 (или 443). Проверка на сервере шлюза:

```bash
ss -tlnp | grep 8443
# или
netstat -tlnp | grep 8443
```

Должен быть процесс Java (gateway) на **0.0.0.0:8443** или **:::8443**. Если слушает только 127.0.0.1:8443 — запросы из сети до приложения не дойдут.

---

## 4. Краткий чеклист

| Шаг | Проверка | Ожидание |
|-----|----------|----------|
| 1 | `nslookup rr5---sn-4g5ednkr.googlevideo.com` с клиента | 88.210.20.137 |
| 2 | `curl -v -k https://88.210.20.137:8443/ -H "Host: rr5---sn-4g5ednkr.googlevideo.com"` | Подключение и строка в логах шлюза |
| 3 | На сервере шлюза: `ss -tlnp \| grep 8443` | 0.0.0.0:8443 или :::8443 |
| 4 | Роутер: правило DNAT 88.210.20.137:443 → gateway_host:8443 | Включено и активно |

Если на шаге 1 не 88.210.20.137 — править DNS (dnsmasq на роутере и использование этого DNS на клиенте).  
Если на шаге 2 таймаут/refused — править сеть/роутер/DNAT и порт, на котором слушает шлюз.

---

## 5. Если запрос доходит (есть логи), но видео не грузится

- Убедиться, что в сертификате шлюза есть SAN для `*.googlevideo.com` (и остальных доменов), см. [certificate-windows-debian-docker.md](certificate-windows-debian-docker.md).
- Проверить, что на устройстве установлен и доверен **ca.crt**.
- В конфиге шлюза для прозрачного прокси задан `response-timeout: -1` (без таймаута для стрима), CORS не дублируется — см. [option2-tls-termination.md](option2-tls-termination.md) и `application.yml`.
