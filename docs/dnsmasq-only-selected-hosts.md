# Настройка: только выбранные домены идут через Gateway (DNS на роутере)

Инструкция для **ASUS RT-AX53U** с **dnsmasq**: на gateway (88.210.20.137) уходит трафик **только** к указанным доменам (YouTube, Instagram, Netflix, OpenAI, Mastodon и т.д.). Остальные запросы резолвятся как обычно и идут напрямую в интернет — роутер их на gateway не отправляет.

**Принцип:** Роутер по SSH вы уже настроили, dnsmasq установлен (проверено: `dnsmasq -v`). В конфиг dnsmasq добавляются правила вида «домен X → IP 88.210.20.137». Устройства в LAN используют роутер как DNS (через DHCP), поэтому для этих доменов получают IP gateway и подключаются к нему. Остальные домены резолвятся через обычный upstream DNS.

---

## Что должно быть заранее

1. **SSH на роутер** — включён, вы заходите под пользователем (например `admin` или `root` после включения root).
2. **JFFS на роутере** — включён в веб-интерфейсе: **Администрирование** → **Система** → **Enable JFFS custom scripts** (при первом включении иногда делают **Format JFFS partition** один раз).
3. **Gateway доступен по 88.210.20.137** — с устройств в вашей сети должен открываться этот IP (порты 80 и при необходимости 443). Если gateway слушает только 8080, см. раздел про порты ниже.

---

## Шаг 1. Каталог для своего конфига dnsmasq

По SSH на роутере:

```bash
mkdir -p /jffs/configs
```

На многих прошивках ASUS при старте dnsmasq подмешивается файл `/jffs/configs/dnsmasq.conf.add` (если он есть). Проверить можно так:

```bash
ls -la /jffs/configs/
nvram get jffs2_enable
```

Если `jffs2_enable=1` и каталог есть — переходим к шагу 2.

---

## Шаг 2. Файл с подменой доменов на IP gateway

Создайте файл, который будет дополнять конфиг dnsmasq. Все перечисленные ниже домены и их поддомены будут резолвиться в **88.210.20.137** (ваш gateway).

**Важно:** подставьте свой IP gateway, если он другой.

```bash
cat > /jffs/configs/dnsmasq.conf.add << 'ENDOFFILE'
# Только эти домены резолвятся в IP gateway — трафик к ним идёт через gateway. Остальное — как обычно.
# Формат: address=/.домен/IP
# Точка перед доменом = сам домен и все поддомены (например .youtube.com = youtube.com, www.youtube.com, m.youtube.com и т.д.)

address=/.youtube.com/88.210.20.137
address=/.youtube-nocookie.com/88.210.20.137
address=/.googlevideo.com/88.210.20.137
address=/.instagram.com/88.210.20.137
address=/.netflix.com/88.210.20.137
address=/.nflxvideo.net/88.210.20.137
address=/api.openai.com/88.210.20.137
address=/.openai.com/88.210.20.137
address=/.mastodon.social/88.210.20.137
# Добавьте при необходимости другие инстансы Mastodon, например:
# address=/.mastodon.example.com/88.210.20.137
ENDOFFILE
```

Если нужно **добавить или убрать домены** — отредактируйте этот файл (например `vi /jffs/configs/dnsmasq.conf.add` или скопируйте файл с ПК через SCP и залейте обратно).

**Пояснение формата:**

- `address=/.youtube.com/88.210.20.137` — все запросы к `*.youtube.com` и `youtube.com` дают 88.210.20.137.
- `address=/api.openai.com/88.210.20.137` — только точное имя `api.openai.com`.
- Для других инстансов Mastodon добавьте строки вида `address=/.имя.инстанса/88.210.20.137`.

Список выше согласован с типичным `proxy.domains` в gateway; при изменении списка в [application.yml](../src/main/resources/application.yml) (proxy.domains) имеет смысл синхронизировать и этот файл на роутере.

---

## Шаг 3. Перезапуск dnsmasq

Чтобы настройки применились:

```bash
killall dnsmasq
service restart_dnsmasq
```

Если команда `service restart_dnsmasq` не найдена, попробуйте:

```bash
killall dnsmasq
dnsmasq --conf-file=/tmp/dnsmasq.conf
```

(На части прошивок dnsmasq поднимается автоматически скриптами после `killall`; тогда достаточно `killall dnsmasq` и подождать несколько секунд.)

Проверка, что dnsmasq запустился и подхватил ваш конфиг:

```bash
ps w | grep dnsmasq
cat /tmp/dnsmasq.conf 2>/dev/null | grep -A1 "88.210.20.137" || true
```

В выводе `dnsmasq.conf` (если он собирается в `/tmp`) могут быть строки из `/jffs/configs/dnsmasq.conf.add`.

---

## Шаг 4. Проверка с клиента в LAN

С ПК или телефона в той же сети (который получает DNS от роутера):

**Windows (cmd или PowerShell):**
```text
nslookup youtube.com
nslookup api.openai.com
```

**Linux / macOS:**
```bash
nslookup youtube.com
dig youtube.com +short
```

Ожидается: в ответе приходит **88.210.20.137** для этих доменов. Для любого другого домена (например `google.com` или `ya.ru`) должен быть обычный IP, не 88.210.20.137.

Если в ответе не 88.210.20.137 — убедитесь, что устройство действительно использует роутер как DNS (в настройках DHCP или прописан вручную DNS = IP роутера). Перезапустите dnsmasq (шаг 3) и повторите проверку.

---

## Шаг 5. Порт и доступность Gateway

Когда браузер или приложение запрашивает, например, `youtube.com`, оно получает IP 88.210.20.137 и подключается:

- по **HTTP** — к **88.210.20.137:80**
- по **HTTPS** — к **88.210.20.137:443**

Значит, на стороне **88.210.20.137** кто-то должен слушать порты **80** и (для HTTPS) **443**.

- Текущее приложение Spring Cloud Gateway по умолчанию слушает **8080**. Варианты:
  - **Вариант A:** В конфиге приложения задать `server.port: 80` (и при необходимости отдельно 443 с TLS) и открыть эти порты в файрволе сервера.
  - **Вариант B:** Оставить приложение на 8080 и поднять перед ним **обратный прокси** (nginx, Caddy и т.п.), который слушает 80 (и 443) и проксирует запросы на `127.0.0.1:8080`. Тогда снаружи доступны 80/443, внутри — 8080.

Для **HTTPS** (чтобы открывать https://youtube.com и т.д.) на gateway нужна поддержка TLS (вариант 2 из [option2-tls-termination.md](option2-tls-termination.md)): приём 443, свой сертификат, установка корневого CA на устройствах. Иначе после проверки DNS будет ошибка «сайт недоступен» или «недействительный сертификат» при переходе на HTTPS.

**Итог:** для «только выбранные домены через gateway» по DNS достаточно, чтобы на 88.210.20.137 был доступен порт 80 (и при желании 443 с TLS). Список доменов задаётся только в dnsmasq на роутере и при необходимости дублируется в `proxy.domains` на gateway.

---

## Сохранение после перезагрузки роутера

Файл лежит в **/jffs**, поэтому после перезагрузки он сохраняется. При старте прошивка сама подмешивает `/jffs/configs/dnsmasq.conf.add` в конфиг dnsmasq (если у вас включён JFFS и скрипты). После перезагрузки снова выполните проверку (шаг 4).

Если после перезагрузки подмена доменов пропала — значит прошивка не подмешивает `dnsmasq.conf.add` автоматически. Тогда:

1. Проверьте, есть ли в системе скрипт, который собирает конфиг dnsmasq: `grep -r dnsmasq /jffs/scripts/ 2>/dev/null; grep -r dnsmasq /tmp/scripts/ 2>/dev/null`.
2. Можно вызвать добавление вашего файла из скрипта при старте. Создайте `/jffs/scripts/init-start` (если его ещё нет) и сделайте исполняемым:
   ```bash
   #!/bin/sh
   [ -f /jffs/configs/dnsmasq.conf.add ] && cat /jffs/configs/dnsmasq.conf.add >> /tmp/dnsmasq.conf
   ```
   Точный путь к итоговому конфигу dnsmasq (`/tmp/dnsmasq.conf` или другой) смотрите в процессе dnsmasq: `ps w | grep dnsmasq` — там будет указан `--conf-file=...`. На части прошивок конфиг собирается один раз при загрузке; тогда в скрипте после добавления строк нужно выполнить `killall dnsmasq`, чтобы роутер сам перезапустил dnsmasq с новым конфигом.

---

## Отмена подмены (вернуть обычный DNS для всех доменов)

Удалите или переименуйте файл и перезапустите dnsmasq:

```bash
rm /jffs/configs/dnsmasq.conf.add
killall dnsmasq
service restart_dnsmasq
```

После этого все домены снова будут резолвиться только через обычный DNS роутера.

---

## Краткая сводка

| Действие | Где |
|----------|-----|
| Список доменов, которые идут через gateway | `/jffs/configs/dnsmasq.conf.add` на роутере (и при желании `proxy.domains` в application.yml) |
| IP gateway | 88.210.20.137 (подставьте свой в строках `address=/...`) |
| Перезапуск DNS | `killall dnsmasq` и `service restart_dnsmasq` на роутере |
| Проверка | `nslookup youtube.com` с устройства в LAN → ответ 88.210.20.137 |
| Порт на gateway | Должен быть доступен 80 (и 443 для HTTPS) на 88.210.20.137 |

Трафик к **остальным** доменам роутер на gateway не отправляет — они резолвятся и идут как обычно.
